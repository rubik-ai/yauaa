#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2020 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
config:

# From https://en.wikipedia.org/wiki/Android_version_history
# NOTE: Android/9 is ambiguous to either being Android 9 or Android 2.3 in this lookup
# So ONLY use this lookup if SURE this is the API version.
- lookup:
    name: 'AndroidAPIToVersionMap'
    map:
      "1"  : "1.0" # 1.0 (API 1)
      "2"  : "1.1" # 1.1 (API 2)
      "3"  : "1.5" # 1.5 Cupcake (API 3)
      "4"  : "1.6" # 1.6 Donut (API 4)
      "5"  : "2.0" # 2.0 Eclair (API 5)
      "8"  : "2.2" # 2.2 Froyo (API 8)
      "9"  : "2.3" # 2.3 Gingerbread (API 9)
      "11" : "3.0" # 3.0 Honeycomb (API 11)
      "14" : "4.0" # 4.0 Ice Cream Sandwich (API 14)
      "16" : "4.1" # 4.1 Jelly Bean (API 16)
      "19" : "4.4" # 4.4 KitKat (API 19)
      "21" : "5.0" # 5.0 Lollipop (API 21)
      "23" : "6.0" # 6.0 Marshmallow (API 23)
      "24" : "7.0" # 7.0 Nougat (API 24)
      "26" : "8.0" # 8.0 Oreo (API 26)
      "28" : "9"   # 9 Pie (API 28)
      "29" : "10"  # 10 (API 29)
      "30" : "11"  # 11 (API 30)

# =======================================================
# Spotify client

# Spotify Generic
- matcher:
    variable:
      - 'Spotify                             :agent.(1)product.(1)name = "Spotify"'
      - 'System                              :agent.(2)product'
      - 'Device                              :@System.comments.(1)entry'
    extract:
      - 'OperatingSystemName                 :      501 :@System.name'
      - 'OperatingSystemVersion              :      501 :@System.version'
      - 'AgentClass                          :      100 :"Special"'
      - 'AgentName                           :      100 :"Spotify"'
      - 'AgentVersion                        :      100 :@Spotify^.version'

# Spotify Win32
- matcher:
    options:
      - 'only'
      - 'verbose'

    variable:
      - 'Spotify                             :agent.(1)product.(1)name = "Spotify"'
      - 'System                              :agent.(2)product.(1)name = "Win32"^'
      - 'Device                              :@System.comments.(1)entry'
    extract:
      - 'DeviceClass                         :        1 :"Desktop"'
      - 'DeviceName                          :     1110 :@Device'
      - 'OperatingSystemClass                :     1501 :"Desktop"'
      - 'OperatingSystemName                 :     1501 :"Windows"'
      - 'OperatingSystemVersion              :     1501 :"??"'

# Spotify Win64
- matcher:
    variable:
      - 'Spotify                             :agent.(1)product.(1)name = "Spotify"'
      - 'System                              :agent.(2)product.(1)name = "Win64"^'
      - 'Device                              :@System.comments.(1)entry'
    extract:
      - 'DeviceClass                         :        1 :"Desktop"'
      - 'DeviceName                          :     1110 :@Device'
      - 'OperatingSystemClass                :     1501 :"Desktop"'
      - 'OperatingSystemName                 :     1501 :"Windows"'
      - 'OperatingSystemVersion              :     1501 :"??"'

# Spotify Android
- matcher:
    variable:
      - 'Spotify                             :agent.(1)product.(1)name = "Spotify"'
      - 'System                              :agent.(2)product.(1)name = "Android"^'
      - 'Device                              :@System.comments.(1)entry'
    extract:
      - 'DeviceClass                         :        1 :"Mobile"' # Classification based on device name is too hard.
      - 'DeviceName                          :     1110 :@Device'
      - 'DeviceBrand                         :     1400 : LookUpPrefix[MobileBrandPrefixes;@Device;"<<<null>>>"]'
      - 'OperatingSystemClass                :     1501 :"Mobile"'
      - 'OperatingSystemName                 :     1501 :"Android"'
      - 'OperatingSystemVersion              :     1501 :LookUp[AndroidAPIToVersionMap;@System^.version;"??"]'
      - 'AgentClass                          :      100 :"Special"'
      - 'AgentName                           :      100 :"Spotify"'
      - 'AgentVersion                        :      100 :@Spotify^.version'

# Special case for Google Pixel
- matcher:
    variable:
      - 'Android        : agent.product.name="Android"'
      - 'Pixel          : @Android^.(1)comments.(1)entry[1]="Pixel"'
    extract:
      - 'DeviceClass                         :      105 :"Phone"'
      - 'DeviceBrand                         :     1405 :"Google"'
      - 'DeviceName                          :      105 :@Pixel@'

- test:
    input:
      user_agent_string: 'Spotify/8.0.0 Android/22 (Blade A460)'
    expected:
      DeviceClass                           : 'Mobile'
      DeviceName                            : 'ZTE Blade A460'
      DeviceBrand                           : 'ZTE'
      OperatingSystemClass                  : 'Mobile'
      OperatingSystemName                   : 'Android'
      OperatingSystemVersion                : '??'
      OperatingSystemVersionMajor           : '??'
      OperatingSystemNameVersion            : 'Android ??'
      OperatingSystemNameVersionMajor       : 'Android ??'
      AgentClass                            : 'Special'
      AgentName                             : 'Spotify'
      AgentVersion                          : '8.0.0'
      AgentVersionMajor                     : '8'
      AgentNameVersion                      : 'Spotify 8.0.0'
      AgentNameVersionMajor                 : 'Spotify 8'


- test:
    input:
      user_agent_string: 'Spotify/8.2.0 iOS/10.0.1 (iPhone7,2)'
    expected:
      DeviceClass                           : 'Phone'
      DeviceName                            : 'Apple iPhone'
      DeviceBrand                           : 'Apple'
      DeviceVersion                         : 'iPhone 6'
      OperatingSystemClass                  : 'Mobile'
      OperatingSystemName                   : 'iOS'
      OperatingSystemVersion                : '10.0.1'
      OperatingSystemVersionMajor           : '10'
      OperatingSystemNameVersion            : 'iOS 10.0.1'
      OperatingSystemNameVersionMajor       : 'iOS 10'
      AgentClass                            : 'Special'
      AgentName                             : 'Spotify'
      AgentVersion                          : '8.2.0'
      AgentVersionMajor                     : '8'
      AgentNameVersion                      : 'Spotify 8.2.0'
      AgentNameVersionMajor                 : 'Spotify 8'


- test:
    input:
      user_agent_string: 'Spotify/8.5.33 Android/28 (SM-G950F)'
    expected:
      DeviceClass                          : 'Mobile'
      DeviceName                           : 'Samsung SM-G950F'
      DeviceBrand                          : 'Samsung'
      OperatingSystemClass                 : 'Mobile'
      OperatingSystemName                  : 'Android'
      OperatingSystemVersion               : '9'
      OperatingSystemVersionMajor          : '9'
      OperatingSystemNameVersion           : 'Android 9'
      OperatingSystemNameVersionMajor      : 'Android 9'
      LayoutEngineClass                    : 'Unknown'
      LayoutEngineName                     : 'Unknown'
      LayoutEngineVersion                  : '??'
      LayoutEngineVersionMajor             : '??'
      LayoutEngineNameVersion              : 'Unknown ??'
      LayoutEngineNameVersionMajor         : 'Unknown ??'
      AgentClass                           : 'Special'
      AgentName                            : 'Spotify'
      AgentVersion                         : '8.5.33'
      AgentVersionMajor                    : '8'
      AgentNameVersion                     : 'Spotify 8.5.33'
      AgentNameVersionMajor                : 'Spotify 8'

- test:
    input:
      user_agent_string: 'Spotify/8.5.33 Android/29 (Pixel 3a)'
    expected:
      DeviceClass                          : 'Phone'
      DeviceName                           : 'Google Pixel 3A'
      DeviceBrand                          : 'Google'
      OperatingSystemClass                 : 'Mobile'
      OperatingSystemName                  : 'Android'
      OperatingSystemVersion               : '10'
      OperatingSystemVersionMajor          : '10'
      OperatingSystemNameVersion           : 'Android 10'
      OperatingSystemNameVersionMajor      : 'Android 10'
      LayoutEngineClass                    : 'Unknown'
      LayoutEngineName                     : 'Unknown'
      LayoutEngineVersion                  : '??'
      LayoutEngineVersionMajor             : '??'
      LayoutEngineNameVersion              : 'Unknown ??'
      LayoutEngineNameVersionMajor         : 'Unknown ??'
      AgentClass                           : 'Special'
      AgentName                            : 'Spotify'
      AgentVersion                         : '8.5.33'
      AgentVersionMajor                    : '8'
      AgentNameVersion                     : 'Spotify 8.5.33'
      AgentNameVersionMajor                : 'Spotify 8'

- test:
    input:
      user_agent_string: 'Spotify/112000510 Win32/0 (PC laptop)'
    expected:
      DeviceClass                          : 'Desktop'
      DeviceName                           : 'PC Laptop'
      DeviceBrand                          : 'Unknown'
      OperatingSystemClass                 : 'Desktop'
      OperatingSystemName                  : 'Windows'
      OperatingSystemVersion               : '??'
      OperatingSystemVersionMajor          : '??'
      OperatingSystemNameVersion           : 'Windows ??'
      OperatingSystemNameVersionMajor      : 'Windows ??'
      LayoutEngineClass                    : 'Unknown'
      LayoutEngineName                     : 'Unknown'
      LayoutEngineVersion                  : '??'
      LayoutEngineVersionMajor             : '??'
      LayoutEngineNameVersion              : 'Unknown ??'
      LayoutEngineNameVersionMajor         : 'Unknown ??'
      AgentClass                           : 'Special'
      AgentName                            : 'Spotify'
      AgentVersion                         : '112000510'
      AgentVersionMajor                    : '112000510'
      AgentNameVersion                     : 'Spotify 112000510'
      AgentNameVersionMajor                : 'Spotify 112000510'
